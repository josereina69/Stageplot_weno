<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Plot & Rider T√©cnico - Asistente de Programaci√≥n</title>
    
    <script src="https://unpkg.com/konva@9.3.0/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --color-primary: #1a237e; /* Azul oscuro/√≠ndigo */
            --color-secondary: #ffc107; /* Amarillo/√Åmbar */
            --color-background: #f4f5f8;
            --stage-width: 800px;
            --stage-height: 500px;
            --sidebar-width: 200px; /* Nuevo tama√±o para el panel lateral */
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Contenedor principal para el PDF final */
        #documento-final {
            width: calc(var(--stage-width) + var(--sidebar-width) + 50px); /* Ajuste de ancho total */
            background-color: white;
            padding: 25px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 50px;
            position: relative;
        }
        
        /* HEADER (T√≠tulo del proyecto) */
        #header-documento {
            border-bottom: 3px solid var(--color-primary);
            padding-bottom: 12px;
            margin-bottom: 25px; 
            text-align: center;
        }
        #header-title-input {
            border: none;
            font-size: 1.8em;
            font-weight: 700;
            width: 100%;
            text-align: center;
            padding: 5px 0;
            box-sizing: border-box;
        }

        /* ------------------------- */
        /* ZONA DE TRABAJO Y ESCENARIO */
        /* ------------------------- */
        
        /* Nuevo contenedor flexible para Herramientas + Escenario */
        #main-workspace {
            display: flex;
            gap: 20px; /* Espacio entre el men√∫ lateral y el escenario */
            width: 100%;
            max-width: calc(var(--stage-width) + var(--sidebar-width) + 20px);
        }

        /* Panel de Herramientas (Acorde√≥n) - Ahora a la izquierda */
        #herramientas {
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width);
            flex-shrink: 0; 
            margin: 0; 
        }
        .categoria-header {
            background-color: var(--color-primary);
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .categoria-contenido {
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            padding: 10px; 
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            display: flex;
            flex-wrap: wrap;
            gap: 8px; 
            justify-content: space-around;
        }
        .categoria-contenido.abierto {
            border-radius: 0 0 4px 4px;
        }

        .icono-arrastrable {
            border: 2px solid var(--color-primary);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: grab;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            user-select: none;
            width: 75px; 
            transition: background-color 0.1s;
        }
        .icono-arrastrable:hover {
            background-color: #e8eaf6;
        }
        .icono-arrastrable i {
            font-size: 1.5em;
            margin-bottom: 5px;
            color: var(--color-primary);
        }
        
        .control-grupo {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            width: 100%; 
            box-sizing: border-box;
            justify-content: space-between;
        }
        #color-picker {
            width: 50px;
            height: 30px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .categoria-contenido button {
             padding: 5px;
             font-size: 0.85em;
        }


        /* Contenedor del Escenario (Escenario + Reglas) */
        #contenedor-escenario {
            position: relative;
            width: calc(var(--stage-width) + 30px);
            height: calc(var(--stage-height) + 30px);
            margin: 0; 
            border: 1px solid #ddd;
            background-color: #fff;
            flex-grow: 1; 
        }
        #stage-konva-container {
            position: absolute;
            left: 30px;
            top: 0px;
            width: var(--stage-width);
            height: var(--stage-height);
            background-color: transparent;
        }

        /* Reglas/Cotas */
        #ruler-bottom {
            position: absolute;
            bottom: 0;
            left: 30px;
            width: var(--stage-width);
            height: 30px;
            background-color: #e0e0e0;
            border-top: 1px solid #ccc;
        }
        #ruler-left {
            position: absolute;
            top: 0; 
            left: 0;
            width: 30px;
            height: var(--stage-height);
            background-color: #e0e0e0;
            border-right: 1px solid #ccc;
        }
        .ruler-tick {
            position: absolute;
            font-size: 10px;
            color: #555;
            text-align: center;
        }
        #ruler-bottom .ruler-tick {
            border-left: 1px solid #333;
            height: 5px;
            line-height: 30px;
            transform: translateY(0px);
        }
        #ruler-left .ruler-tick {
            width: 5px;
            border-bottom: 1px solid #333;
            line-height: 1;
            padding-right: 5px;
            text-align: right;
            transform: translateX(-1px);
        }

        /* Herramientas y Controles Superiores */
        #toolbar-gestion {
            width: 100%;
            max-width: calc(var(--stage-width) + var(--sidebar-width) + 50px);
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* Estilos espec√≠ficos para los nuevos botones de la barra superior */
        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .toolbar-group button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .toolbar-group button:hover {
            background-color: #3949ab;
        }
        .toolbar-group button:disabled {
            background-color: #b0b0b0;
            cursor: not-allowed;
        }
        /* Estilo para los botones de icono */
        .toolbar-group button.icon-only {
            padding: 8px;
            width: 40px; 
            text-align: center;
        }

        /* Edici√≥n de texto flotante */
        #text-input {
            position: absolute;
            display: none;
            z-index: 1000; 
            padding: 5px;
            border: 1px solid var(--color-secondary);
            background: white;
            font-size: 10px;
            width: 120px;
        }
        
        /* ------------------------- */
        /* ZONA RIDER */
        /* ------------------------- */
        #editor-container { 
            display: block; 
            margin-bottom: 25px;
            width: 100%;
        }

        #rider-container {
            display: none;
            width: 100%;
        }
        #rider-container.visible {
            display: block;
        }
        
        .rider-section-title {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 35px;
            margin-bottom: 15px;
        }
        #editor-quill {
            height: 200px;
            margin-bottom: 25px;
        }
        #btn-add-input, #btn-add-output {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px !important;
            transition: background-color 0.2s;
        }
        .rider-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .rider-table th, .rider-table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        .rider-table th {
            background-color: var(--color-primary);
            color: white;
        }
        .cell-input {
            width: 95%;
            border: none;
            background: transparent;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        .btn-eliminar {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        #output-footer-info {
            border-top: 2px solid var(--color-primary);
            padding-top: 15px;
            margin-top: 35px;
            margin-bottom: 20px;
        }
        .footer-info-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 2fr;
            gap: 10px 20px;
            align-items: center;
        }
        .footer-info-grid label {
            font-weight: bold;
            text-align: right;
        }
        #output-footer-info input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .hidden { display: none !important; }

        /* Estilos de Drag and Drop para filas de tablas */
        .rider-table tr {
            cursor: grab;
        }
        .rider-table tr.dragging {
            opacity: 0.5;
            background-color: #e0f7fa; /* Color para indicar que se est√° arrastrando */
        }
        .rider-table tr td:first-child input {
            width: 30px; /* Tama√±o del input CH para que sea discreto */
            text-align: center;
            font-weight: bold;
        }

        /* Estilos para el icono personalizado */
        .icono-arrastrable.custom-icon-preview {
            padding: 0;
            width: 75px; 
            height: 75px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icono-arrastrable.custom-icon-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #file-input-label {
            display: block;
            background-color: #4CAF50; /* Un verde amigable */
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        #file-input-label:hover {
            background-color: #45a049;
        }
        #custom-icon-preview-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        #custom-icon-preview-container img {
            max-width: 75px;
            max-height: 75px;
            object-fit: contain;
            border: 1px solid #ddd;
            padding: 5px;
        }
    </style>
</head>
<body>

    <div id="toolbar-gestion">
        
        <div class="toolbar-group">
            <button id="btn-stageplot" class="active" onclick="setView('stagePlot')">Stage Plot</button>
            <button id="btn-rider" onclick="setView('rider')">Rider T√©cnico</button>
            
            <button onclick="newProject()" title="Empezar un nuevo proyecto"><i class="fas fa-file"></i> Nuevo</button>
            <button onclick="saveProject()" title="Guardar estado en el navegador"><i class="fas fa-save"></i> Guardar</button>
            <button onclick="loadProject()" title="Cargar estado guardado"><i class="fas fa-folder-open"></i> Cargar</button>
        </div>
        
        <div class="toolbar-group" id="acciones-flotantes">
            
            <button id="btn-eliminar-seleccionado" disabled title="Eliminar el elemento seleccionado" class="icon-only">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button onclick="generarStagePlotPDF()" title="Exportar s√≥lo el plano del escenario"><i class="fas fa-file-image"></i> Exportar Plot PDF</button>
            <button onclick="generarListasPDF()" title="Exportar s√≥lo la lista de canales y salidas"><i class="fas fa-list"></i> Exportar Listas PDF</button>
            <button onclick="generarRiderCompletoPDF()" title="Exportar el documento Rider completo"><i class="fas fa-file-pdf"></i> Exportar Rider Completo</button>
        </div>
    </div>
    
    <div id="documento-final">
        <div id="header-documento">
            <input type="text" id="header-title-input" value="STAGE PLOT & RIDER T√âCNICO" onchange="saveStateSilencioso()">
        </div>

        <div id="editor-container">

            <div id="main-workspace">
                
                <div id="herramientas">
                    <div class="categoria-header" onclick="toggleAcordeon(this)">
                        Edici√≥n <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="categoria-contenido abierto">
                        <div class="control-grupo">
                            <label for="color-picker">Color:</label>
                            <input type="color" id="color-picker" value="#1a237e">
                        </div>
                    </div>

                    <div class="categoria-header" onclick="toggleAcordeon(this)">
                        Elementos de Audio <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="categoria-contenido">
                        <div class="icono-arrastrable" draggable="true" data-tipo="microfono">
                            <i class="fa-solid fa-microphone"></i> Micr√≥fono
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="cajadi">
                            <i class="fa-solid fa-box-open-fll"></i> Caja DI
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="receptor_mic">
                            <i class="fa-solid fa-wifi"></i> Rx Mic.
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="receptor_iem">
                            <i class="fa-solid fa-headphones-simple"></i> Rx IEM
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="monitor">
                            <i class="fa-solid fa-speaker"></i> Monitor
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="amplificador">
                            <i class="fa-solid fa-volume-up"></i> Amplificador
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="consola">
                            <i class="fa-solid fa-mixer"></i> Consola
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="stagebox">
                            <i class="fa-solid fa-box-taped"></i> Stage Box
                        </div>
                    </div>

                    <div class="categoria-header" onclick="toggleAcordeon(this)">
                        Instrumentos y Muebles <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="categoria-contenido">
                        <div class="icono-arrastrable" draggable="true" data-tipo="bateria">
                            <i class="fa-solid fa-drum-set"></i> Bater√≠a
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="teclado">
                            <i class="fa-solid fa-piano"></i> Teclado
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="portatil">
                            <i class="fa-solid fa-laptop"></i> Port√°til
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="atrils">
                            <i class="fa-solid fa-music-note-list"></i> Atril
                        </div>
                        <div class="icono-arrastrable" draggable="true" data-tipo="tarima">
                            <i class="fa-solid fa-square"></i> Tarima
                        </div>
                    </div>

                    <div class="categoria-header" onclick="toggleAcordeon(this)">
                        Icono Personalizado <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="categoria-contenido">
                        <input type="file" id="custom-icon-file-input" accept="image/png, image/jpeg, image/svg+xml" style="display: none;">
                        <label for="custom-icon-file-input" id="file-input-label">Subir Imagen</label>
                        <div id="custom-icon-preview-container">
                            
</div>
                    </div>
                </div>

                <div id="contenedor-escenario">
                    <div id="ruler-left"></div>
                    <div id="ruler-bottom"></div>
                    <div id="stage-konva-container"></div>
                    <input type="text" id="text-input" style="display: none;">
                </div>
            </div>
            
            <div id="rider-container">
                
                <h3 class="rider-section-title">Especificaciones Adicionales (Backline, Notas, etc.)</h3>
                <div id="editor-quill"></div>
                
                <h3 class="rider-section-title">Lista de Canales (Input List) üé§</h3>
                <button id="btn-add-input" onclick="agregarFilaManual('input')" style="margin-bottom: 10px;">+ A√±adir Input Manual</button>
                <table class="rider-table" id="input-list-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">CH</th>
                            <th style="width: 30%;">Fuente (Stage Plot Label)</th>
                            <th style="width: 25%;">Mic/DI Sugerido</th>
                            <th style="width: 30%;">Preamp / Notas</th>
                            <th style="width: 10%;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-canales-body">
                        </tbody>
                </table>

                <h3 class="rider-section-title">Lista de Salidas (Output/Mix List) üéß</h3>
                <button id="btn-add-output" onclick="agregarFilaManual('output')" style="margin-bottom: 10px;">+ A√±adir Output Manual</button>
                <table class="rider-table" id="output-list-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">Mix</th>
                            <th style="width: 40%;">Destino</th>
                            <th style="width: 45%;">Notas / Eq</th>
                            <th style="width: 10%;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-salidas-body">
                        </tbody>
                </table>
                
                <div id="output-footer-info">
                    <h3 class="rider-section-title">Informaci√≥n del Show</h3>
                    <div class="footer-info-grid">
                        <label>Artista/Banda:</label>
                        <input type="text" data-key="artist_name" placeholder="Nombre de la Banda">
                        
                        <label>Fecha del Show:</label>
                        <input type="date" data-key="show_date">

                        <label>Manager de Producci√≥n:</label>
                        <input type="text" data-key="prod_manager" placeholder="Nombre de contacto">
                        
                        <label>Tel. Manager:</label>
                        <input type="tel" data-key="prod_phone" placeholder="+34 600 00 00 00">
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
    // ----------------------------------------------------
    // CONFIGURACI√ìN INICIAL Y OBJETOS GLOBALES 
    // ----------------------------------------------------
    const METERS_PER_PIXEL = 1 / 50; 
    const STAGE_WIDTH = 800;  
    const STAGE_HEIGHT = 500; 
    const GRID_SIZE = 50; 
    const ICON_SIZE = 25; 
    const STORAGE_KEY = 'stageplot_project_v1'; 
    const CUSTOM_ICON_STORAGE_KEY = 'stageplot_custom_icon'; 

    let canalActual = 0;
    let salidaActual = 0;
    let activeTextNode = null;
    let transformer = null;
    let selectedShape = null;
    let currentView = 'stagePlot';
    let customIconDataURL = null; 

    const { jsPDF } = window.jspdf;

    const stage = new Konva.Stage({
        container: 'stage-konva-container',
        width: STAGE_WIDTH, 
        height: STAGE_HEIGHT, 
    });

    let layer = new Konva.Layer();
    stage.add(layer);

    // Inicializaci√≥n de Quill y elementos del DOM
    var quill = new Quill('#editor-quill', {
        theme: 'snow',
        placeholder: 'A√±ade aqu√≠ tus especificaciones de Backline, Hospitalidad, etc.',
        modules: {
            toolbar: [['bold', 'italic', 'underline'], ['list', 'header'], ['clean']]
        }
    });
    quill.on('text-change', saveStateSilencioso); 

    const colorPicker = document.getElementById('color-picker');
    const headerTitleInput = document.getElementById('header-title-input');
    const riderInputs = document.querySelectorAll('#output-footer-info input[data-key]');
    const btnEliminarSeleccionado = document.getElementById('btn-eliminar-seleccionado');
    const textInput = document.getElementById('text-input');
    const customIconFileInput = document.getElementById('custom-icon-file-input');
    const customIconPreviewContainer = document.getElementById('custom-icon-preview-container');


    // ----------------------------------------------------
    // L√ìGICA DE PERSISTENCIA (GUARDAR Y CARGAR) üíæ
    // ----------------------------------------------------
    
    /** Guarda el estado sin mostrar un alert (para interacciones autom√°ticas). */
    function saveStateSilencioso() {
        const stageJSON = stage.toJSON();
        const quillContent = quill.getContents();
        const inputListBody = document.getElementById('lista-canales-body').innerHTML;
        const outputListBody = document.getElementById('lista-salidas-body').innerHTML;

        const riderData = {};
        riderInputs.forEach(input => {
            riderData[input.getAttribute('data-key')] = input.value;
        });

        const projectData = {
            stage: stageJSON,
            quill: quillContent,
            inputList: inputListBody,
            outputList: outputListBody,
            riderData: riderData,
            canalActual: canalActual, 
            salidaActual: salidaActual,
            headerTitle: headerTitleInput.value,
            customIconDataURL: customIconDataURL
        };

        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            console.log("Guardado autom√°tico: Estado del proyecto actualizado.");
        } catch (e) {
            console.error('Error al guardar el proyecto en localStorage:', e);
        }
    }

    window.saveProject = function() {
        saveStateSilencioso();
        alert('‚úÖ Proyecto guardado exitosamente en el navegador.');
    }

    window.loadProject = function() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) {
            drawGridAndFrame(); 
            console.log('No se encontr√≥ proyecto guardado. Iniciando lienzo vac√≠o.');
            return;
        }

        try {
            const projectData = JSON.parse(savedData);
            
            // 1. Cargar Konva
            stage.destroyChildren();
            const tempContainer = document.createElement('div');
            const tempStage = Konva.Node.create(projectData.stage, tempContainer);
            
            layer = new Konva.Layer();
            stage.add(layer);
            
            tempStage.find('.movable-group').forEach(group => {
                layer.add(group);
                // Re-a√±adir event listeners
                group.on('dragend', saveStateSilencioso);
                group.on('transformend', function () { 
                    const label = group.children.find(c => c.name() === 'icon-label');
                    if (label) {
                        // Recalcular posici√≥n del label
                        const groupWidth = group.width() * group.scaleX();
                        const groupHeight = group.height() * group.scaleY();
                        
                        label.x(groupWidth / 2); 
                        label.y(-label.height() - 5); 
                        label.offsetX(label.width() / 2);
                    }
                    layer.draw();
                    saveStateSilencioso(); 
                });
                group.on('dblclick dbltap', function (e) { 
                    e.cancelBubble = true; 
                    activeTextNode = group.children.find(c => c.name() === 'icon-label');
                    showTextEditor(activeTextNode);
                });
                group.on('click tap', function (e) { selectShape(group); });
            });

            drawGridAndFrame();
            layer.draw();

            // 2. Cargar Quill y Rider Data
            quill.setContents(projectData.quill);
            document.getElementById('lista-canales-body').innerHTML = projectData.inputList;
            document.getElementById('lista-salidas-body').innerHTML = projectData.outputList;
            
            // Re-vincular eventos de arrastre y edici√≥n manual
            attachDragEvents();


            // Cargar los inputs del Rider 
            riderInputs.forEach(input => {
                const key = input.getAttribute('data-key');
                if (projectData.riderData && projectData.riderData[key] !== undefined) {
                    input.value = projectData.riderData[key];
                }
            });

            canalActual = projectData.canalActual || 0;
            salidaActual = projectData.salidaActual || 0;
            headerTitleInput.value = projectData.headerTitle || "STAGE PLOT & RIDER T√âCNICO";
            
            // Cargar icono personalizado
            if (projectData.customIconDataURL) {
                customIconDataURL = projectData.customIconDataURL;
                displayCustomIconInPanel(customIconDataURL);
            }

            alert('‚úÖ Proyecto cargado exitosamente.');
        } catch (e) {
            console.error(e);
            alert('‚ùå Error al cargar el proyecto: Los datos guardados son inv√°lidos. Revisa la consola para m√°s detalles.');
        }
    }

    function saveState() {
        saveStateSilencioso();
    }
    
    // ----------------------------------------------------
    // L√ìGICA KONVA
    // ----------------------------------------------------

    function getFaUnicode(tipo) {
        const iconMap = {
            'microfono': '\uf130',    
            'cajadi': '\uf6a3',       
            'receptor_mic': '\uf1eb', 
            'receptor_iem': '\uf5e7', 
            'amplificador': '\uf028', 
            'bateria': '\uf5e8',      
            'teclado': '\uf890',      
            'atrils': '\uf518',       
            'monitor': '\uf5e6',      
            'consola': '\uf640',       
            'portatil': '\uf109',      
            'stagebox': '\uf466',      
        };
        return iconMap[tipo] || '\uf041';
    }

    function createKonvaIcon(tipo, x, y, fill, imageDataURL = null) {
        const uniqueId = `konva-${Date.now()}`;
        let mainShape;
        let defaultLabel = tipo.charAt(0).toUpperCase() + tipo.slice(1);
        let canalAsignado = 0;
        let offsetX = 0;
        let offsetY = 0;
        let groupWidth = ICON_SIZE;
        let groupHeight = ICON_SIZE;


        if (imageDataURL) {
            // Icono personalizado (imagen)
            defaultLabel = "Imagen Personalizada";
            const img = new Image();
            img.src = imageDataURL;
            mainShape = new Konva.Image({
                image: img,
                x: 0, y: 0,
                width: ICON_SIZE, height: ICON_SIZE,
                name: 'icon-shape', data_type: 'custom_image', data_id_vinculacion: uniqueId,
            });
            groupWidth = ICON_SIZE;
            groupHeight = ICON_SIZE;
            offsetX = ICON_SIZE / 2;
            offsetY = ICON_SIZE / 2;

        } else if (tipo === 'tarima') {
            // Tarima: Rect√°ngulo de 2m x 1m (100px x 50px)
            mainShape = new Konva.Rect({
                x: 0, y: 0,
                width: 100, height: 50, // 2m x 1m
                fill: fill, stroke: 'black', strokeWidth: 1,
                name: 'icon-shape', data_type: tipo, data_id_vinculacion: uniqueId,
            });
            defaultLabel = "Tarima";
            groupWidth = 100;
            groupHeight = 50;
            offsetX = 100 / 2; // Centrar en el rect√°ngulo
            offsetY = 50 / 2; // Centrar en el rect√°ngulo

        } else {
            // Iconos de Font Awesome
            const unicode = getFaUnicode(tipo);
            mainShape = new Konva.Text({
                x: 0, y: 0,
                text: unicode, fontSize: ICON_SIZE, fontFamily: 'Font Awesome 6 Free', 
                fontStyle: '900', fill: fill, name: 'icon-shape', 
                data_type: tipo, data_id_vinculacion: uniqueId, 
            });
            groupWidth = ICON_SIZE;
            groupHeight = ICON_SIZE;
            offsetX = ICON_SIZE / 2;
            offsetY = ICON_SIZE / 2;
        }

        const label = new Konva.Text({
            x: 0, y: 0, 
            text: defaultLabel,
            fontSize: 10, fontFamily: 'Arial, sans-serif', fill: fill, align: 'center',
            name: 'icon-label', listening: false, rotation: 0,
        });

        const group = new Konva.Group({
            x: x, y: y, draggable: true, name: 'movable-group',
            data_id_vinculacion: uniqueId,
            data_type: tipo, data_canal: canalAsignado,
            offsetX: offsetX, offsetY: offsetY // Centrar el arrastre
        });

        group.add(mainShape);
        group.add(label);
        
        // Ajustar posici√≥n inicial del label despu√©s de a√±adirlo al grupo y conocer su tama√±o
        label.x(groupWidth / 2); // Centrar en el ancho del grupo
        label.y(-label.height() - 5); // Posicionar encima del grupo
        label.offsetX(label.width() / 2); // Centrar el texto en su propio eje X

        group.on('dragend', saveStateSilencioso); 

        group.on('transformend', function () {
            // FIX: La escala ya no se resetea aqu√≠, permitiendo el redimensionamiento
            const labelNode = group.children.find(c => c.name() === 'icon-label');
            if (labelNode) {
                // Usamos group.width() y group.height() para calcular el centro
                labelNode.x(group.width() * group.scaleX() / 2); 
                labelNode.y(-labelNode.height() - 5);
                labelNode.offsetX(labelNode.width() / 2);
            }
            layer.draw();
            saveStateSilencioso(); 
        });

        group.on('dblclick dbltap', function (e) {
            e.cancelBubble = true; 
            activeTextNode = group.children.find(c => c.name() === 'icon-label');
            showTextEditor(activeTextNode);
        });
        
        group.on('click tap', function (e) {
            selectShape(group);
        });

        return group;
    }
    
    function removeTransformer() {
        if (transformer) {
            transformer.destroy();
            transformer = null;
        }
        selectedShape = null;
        btnEliminarSeleccionado.disabled = true;
        layer.draw();
    }
    
    function selectShape(shape) {
        if (selectedShape === shape) return;
        removeTransformer();
        
        if (shape && shape.name() === 'movable-group') {
            selectedShape = shape;
            transformer = new Konva.Transformer({
                node: shape,
                enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                boundBoxFunc: (oldBox, newBox) => (newBox.width < 5 || newBox.height < 5) ? oldBox : newBox,
                rotateAnchorOffset: 50,
            });
            layer.add(transformer);
            btnEliminarSeleccionado.disabled = false;
        } else {
            btnEliminarSeleccionado.disabled = true;
        }
        layer.draw();
    }

    // El bot√≥n de eliminar se movi√≥ a la barra superior
    btnEliminarSeleccionado.addEventListener('click', () => {
        if (selectedShape) {
            const idVinculacion = selectedShape.getAttr('data_id_vinculacion');
            selectedShape.destroy();
            removeTransformer();
            eliminarFila(idVinculacion); // Esto eliminar√° la fila si existe
            // ¬°La renumeraci√≥n ahora est√° dentro de eliminarFila!
        }
    });

    stage.on('click tap', function (e) {
        if (e.target === stage || e.target.name() === 'stage-frame') {
            removeTransformer();
            textInput.style.display = 'none';
        }
    });

    colorPicker.addEventListener('input', function() {
        if (selectedShape) {
            const iconShape = selectedShape.children.find(c => c.name() === 'icon-shape');
            const iconLabel = selectedShape.children.find(c => c.name() === 'icon-label');
            if (iconShape && iconShape.getAttr('data_type') !== 'custom_image') { // No cambiar color de img custom
                iconShape.fill(this.value);
            }
            if (iconLabel) iconLabel.fill(this.value);
            layer.draw();
            saveStateSilencioso(); 
        }
    });

    function showTextEditor(textNode) {
        const stageBox = stage.container().getBoundingClientRect();
        const nodePos = textNode.absolutePosition();
        
        textInput.value = textNode.text();
        textInput.style.display = 'block';
        // Ajuste de posici√≥n: el editor de texto flotante debe tener en cuenta el offset de la regla lateral (30px)
        const stageKonvaContainer = document.getElementById('stage-konva-container');
        const stageKonvaRect = stageKonvaContainer.getBoundingClientRect();
        
        textInput.style.left = (stageKonvaRect.left + nodePos.x) + 'px';
        textInput.style.top = (stageKonvaRect.top + nodePos.y - textInput.offsetHeight / 2) + 'px';

        textInput.focus();

        textInput.onblur = function() {
            textNode.text(textInput.value);
            // Reajustar label al grupo padre despu√©s de editar texto
            const parentGroup = textNode.getParent();
            if (parentGroup) {
                // Usamos group.width() y group.height() para calcular el centro despu√©s de la escala
                const groupWidth = parentGroup.width() * parentGroup.scaleX();
                const groupHeight = parentGroup.height() * parentGroup.scaleY();
                
                textNode.x(groupWidth / 2);
                textNode.y(-textNode.height() - 5);
                textNode.offsetX(textNode.width() / 2);
            }
            textInput.style.display = 'none';
            layer.draw();
            saveStateSilencioso(); 
            // Tambi√©n actualizamos el label de la fila del rider si est√° vinculada
            const idVinculacion = selectedShape.getAttr('data_id_vinculacion');
            const rowInput = document.querySelector(`tr[data-id-vinculacion="${idVinculacion}"] td:nth-child(2) input`);
            if (rowInput) {
                rowInput.value = textInput.value;
                saveStateSilencioso();
            }
        };

        textInput.onkeydown = function(e) {
            if (e.key === 'Enter') {
                textInput.blur();
            }
        };
    }

    const toolIcons = document.querySelectorAll('.icono-arrastrable');
    toolIcons.forEach(icon => {
        icon.addEventListener('dragstart', (e) => {
            const dataType = e.target.getAttribute('data-tipo');
            e.dataTransfer.setData('text/plain', dataType);
            if (dataType === 'custom_image' && customIconDataURL) {
                 e.dataTransfer.setData('image/png', customIconDataURL); // Para el Konva.Image
            }
        });
    });

    const stageContainer = document.getElementById('contenedor-escenario');
    stageContainer.addEventListener('dragover', (e) => e.preventDefault());

    stageContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        const tipo = e.dataTransfer.getData('text/plain');

        if (!tipo) return;

        const stageRect = stageContainer.getBoundingClientRect();
        // Ajustamos la posici√≥n de ca√≠da para que est√© dentro del stage-konva-container (izq: 30px)
        const dropX = e.clientX - stageRect.left - 30; 
        const dropY = e.clientY - stageRect.top;

        let newIcon;
        if (tipo === 'custom_image' && customIconDataURL) {
            newIcon = createKonvaIcon(tipo, dropX, dropY, colorPicker.value, customIconDataURL);
        } else {
            newIcon = createKonvaIcon(tipo, dropX, dropY, colorPicker.value);
        }
        
        layer.add(newIcon);
        layer.draw();
        selectShape(newIcon);
        saveStateSilencioso(); 
    });

    // L√≥gica para subir icono personalizado
    customIconFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                customIconDataURL = event.target.result;
                displayCustomIconInPanel(customIconDataURL);
                saveStateSilencioso(); // Guardar el data URL en el proyecto
            };
            reader.readAsDataURL(file);
        }
    });

    function displayCustomIconInPanel(dataURL) {
        customIconPreviewContainer.innerHTML = ''; // Limpiar previsualizaci√≥n anterior
        const img = document.createElement('img');
        img.src = dataURL;

        const draggableDiv = document.createElement('div');
        draggableDiv.className = 'icono-arrastrable custom-icon-preview';
        draggableDiv.draggable = true;
        draggableDiv.setAttribute('data-tipo', 'custom_image');
        draggableDiv.appendChild(img);

        customIconPreviewContainer.appendChild(draggableDiv);
        attachToolIconDragEvent(draggableDiv); // Re-adjuntar el evento de arrastre
    }

    function attachToolIconDragEvent(iconElement) {
        iconElement.addEventListener('dragstart', (e) => {
            const dataType = e.target.closest('.icono-arrastrable').getAttribute('data-tipo');
            e.dataTransfer.setData('text/plain', dataType);
            if (dataType === 'custom_image' && customIconDataURL) {
                 e.dataTransfer.setData('image/png', customIconDataURL);
            }
        });
    }

    // ----------------------------------------------------
    // DIBUJO DE CUADR√çCULA Y COTAS üìè 
    // ----------------------------------------------------

    function drawGridAndFrame() {
        layer.children.forEach(child => {
            if (child.name() !== 'movable-group') {
                child.destroy();
            }
        }); 
        
        document.getElementById('ruler-bottom').innerHTML = '';
        document.getElementById('ruler-left').innerHTML = '';

        // 1. Dibujar el marco del escenario
        const frame = new Konva.Rect({
            x: 0, y: 0, width: STAGE_WIDTH, height: STAGE_HEIGHT,
            stroke: '#1a237e', strokeWidth: 3, fill: '#ffffff',
            name: 'stage-frame'
        });
        layer.add(frame);
        frame.moveToBottom(); 

        const rulerBottomEl = document.getElementById('ruler-bottom');
        const rulerLeftEl = document.getElementById('ruler-left');
        
        // 2. Regla Horizontal (Eje X: Ancho, -8m a +8m)
        const totalMetersX = STAGE_WIDTH / GRID_SIZE; 
        const halfWidth = totalMetersX / 2;

        for (let i = 0; i <= totalMetersX; i++) {
            const xPos = i * GRID_SIZE;
            layer.add(new Konva.Line({ points: [xPos, 0, xPos, STAGE_HEIGHT], stroke: '#e0e0e0', strokeWidth: 1, name: 'grid-line' }));
            
            const metros = i - halfWidth;
            if (i % 2 === 0 || metros === 0) { 
                const tick = document.createElement('div');
                tick.className = 'ruler-tick';
                tick.style.left = (xPos - 5) + 'px'; 
                tick.style.borderLeft = (metros === 0 ? '2px' : '1px') + ' solid #333333';
                tick.innerHTML = `${metros}m`;
                rulerBottomEl.appendChild(tick);
            }
        }

        // 3. Regla Vertical (Eje Y: Profundidad, 0m ABAJO a 10m ARRIBA)
        const totalMetersY = STAGE_HEIGHT / GRID_SIZE; 

        for (let j = 0; j <= totalMetersY; j++) {
            const yPos = j * GRID_SIZE;
            layer.add(new Konva.Line({
                points: [0, yPos, STAGE_WIDTH, yPos],
                stroke: '#e0e0e0',
                strokeWidth: 1,
                name: 'grid-line'
            }));
            
            // L√≥gica de inversi√≥n para que 0m est√© ABAJO (y=500px)
            const metros = totalMetersY - j; 

            const tick = document.createElement('div');
            tick.className = 'ruler-tick';
            tick.style.top = (yPos) + 'px'; 
            tick.innerHTML = `${metros}m`;
            rulerLeftEl.appendChild(tick);
        }
        
        layer.draw();
    }
    
    // ----------------------------------------------------
    // L√ìGICA RIDER (Listas, Eliminaci√≥n, Secuencia y ARRASTRAR)
    // ----------------------------------------------------

    /**
     * Revisa las tablas de Input y Output, y renombra las filas CH/Mix desde 1.
     */
    function renumerarCanales() {
        let nuevoCanalActual = 0;
        let nuevaSalidaActual = 0;

        // 1. Renumerar Input List
        const inputRows = document.querySelectorAll('#lista-canales-body tr');
        inputRows.forEach((row, index) => {
            const chInput = row.querySelector('.ch-input');
            if (chInput) {
                chInput.value = index + 1;
            }
        });
        nuevoCanalActual = inputRows.length;

        // 2. Renumerar Output List
        const outputRows = document.querySelectorAll('#lista-salidas-body tr');
        outputRows.forEach((row, index) => {
            const mixInput = row.querySelector('.ch-input');
            if (mixInput) {
                mixInput.value = index + 1;
            }
        });
        nuevaSalidaActual = outputRows.length;

        // 3. Actualizar contadores globales
        canalActual = nuevoCanalActual;
        salidaActual = nuevaSalidaActual;
        
        // Guardar el estado despu√©s de renumerar
        saveStateSilencioso();
    }

    function getNextAvailableChannel(listaTipo) {
        // Esta funci√≥n ahora solo devuelve el valor actual de la variable global + 1
        if (listaTipo === 'input') {
            return canalActual + 1;
        } else {
            return salidaActual + 1;
        }
    }


    window.agregarFilaCanal = function(numero, tipo, idVinculacion, nombrePorDefecto, listaTipo) {
        const tbody = document.getElementById(listaTipo === 'input' ? 'lista-canales-body' : 'lista-salidas-body');
        
        const newRow = tbody.insertRow();
        newRow.setAttribute('data-id-vinculacion', idVinculacion);
        newRow.setAttribute('draggable', 'true'); 
        newRow.setAttribute('data-list-type', listaTipo); 

        // Usamos index + 1 como n√∫mero temporal, luego renumeramos
        const chInputHTML = `<input type="number" class="cell-input ch-input" value="${numero}" min="1" onchange="saveStateSilencioso()" onkeyup="saveStateSilencioso()">`;

        if (listaTipo === 'input') {
            newRow.innerHTML = `
                <td>${chInputHTML}</td>
                <td><input type="text" class="cell-input" value="${nombrePorDefecto}" data-label-tipo="source" onchange="updateKonvaLabel('${idVinculacion}', this.value)" onkeyup="saveStateSilencioso()"></td>
                <td><input type="text" class="cell-input" value="${tipo === 'microfono' ? 'SM57' : (tipo === 'cajadi' ? 'DI' : '')}" onchange="saveStateSilencioso()" onkeyup="saveStateSilencioso()"></td>
                <td><input type="text" class="cell-input" value="" onchange="saveStateSilencioso()" onkeyup="saveStateSilencioso()"></td>
                <td><button class="btn-eliminar" onclick="eliminarFila('${idVinculacion}')">X</button></td>
            `;
        } else {
             newRow.innerHTML = `
                <td>${chInputHTML}</td>
                <td><input type="text" class="cell-input" value="${nombrePorDefecto}" data-label-tipo="dest" onchange="saveStateSilencioso()" onkeyup="saveStateSilencioso()"></td>
                <td><input type="text" class="cell-input" value="" onchange="saveStateSilencioso()" onkeyup="saveStateSilencioso()"></td>
                <td><button class="btn-eliminar" onclick="eliminarFila('${idVinculacion}')">X</button></td>
            `;
        }
        
        attachDragEventsToRow(newRow); 
        // No llamamos a saveStateSilencioso aqu√≠, lo hace renumerarCanales
    }
    
    window.updateKonvaLabel = function(idVinculacion, newText) {
        const konvaElement = layer.find(`.movable-group[data_id_vinculacion="${idVinculacion}"]`)[0];
        if (konvaElement) {
            const label = konvaElement.children.find(c => c.name() === 'icon-label');
            if (label) {
                label.text(newText);
                const parentGroup = label.getParent();
                if (parentGroup) {
                    // Usamos la escala actual del grupo para el ajuste
                    const groupWidth = parentGroup.width() * parentGroup.scaleX();
                    const groupHeight = parentGroup.height() * parentGroup.scaleY();
                    
                    label.x(groupWidth / 2);
                    label.y(-label.height() - 5);
                    label.offsetX(label.width() / 2);
                }
                layer.draw();
                saveStateSilencioso();
            }
        }
    }

    window.agregarFilaManual = function(listaTipo) {
        // Usamos un n√∫mero temporal (1, por ejemplo) ya que renumerarCanales lo corregir√°
        const numeroDummy = 1; 
        const idVinculacion = `manual-${Date.now()}`;
        const nombrePorDefecto = listaTipo === 'input' ? 'Input Manual' : 'Output Manual';
        
        agregarFilaCanal(numeroDummy, 'manual', idVinculacion, nombrePorDefecto, listaTipo); 
        
        renumerarCanales(); // <-- ¬°IMPORTANTE! Asigna el n√∫mero CH/Mix correcto (√∫ltimo + 1)
    }

    window.eliminarFila = function(idVinculacion) {
        document.querySelectorAll(`tr[data-id-vinculacion="${idVinculacion}"]`).forEach(row => row.remove());

        const konvaElement = layer.find(`.movable-group[data_id_vinculacion="${idVinculacion}"]`)[0];
        if (konvaElement) {
            konvaElement.destroy();
            removeTransformer(); 
            layer.draw();
        }
        
        renumerarCanales(); // <-- ¬°NUEVO! Vuelve a numerar desde 1 y actualiza los contadores
    }
    
    // Implementaci√≥n de Drag and Drop para filas de tablas
    let draggedRow = null;

    function attachDragEventsToRow(row) {
        row.addEventListener('dragstart', (e) => {
            draggedRow = row;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', row.getAttribute('data-id-vinculacion'));
            setTimeout(() => row.classList.add('dragging'), 0);
        });

        row.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (e.target.closest('tr') && e.target.closest('tr') !== draggedRow) {
                e.target.closest('tr').classList.add('drag-over');
            }
        });

        row.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
        });

        row.addEventListener('dragleave', (e) => {
            e.target.closest('tr').classList.remove('drag-over');
        });

        row.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetRow = e.target.closest('tr');
            
            if (draggedRow && targetRow && draggedRow !== targetRow) {
                const targetTbody = targetRow.parentNode;
                const draggedTbody = draggedRow.parentNode;

                // Asegurar que el arrastre sea solo dentro de la misma tabla
                if (targetTbody === draggedTbody) {
                    const rect = targetRow.getBoundingClientRect();
                    const nextTo = (e.clientY > rect.top + rect.height / 2) ? targetRow.nextSibling : targetRow;
                    
                    if (nextTo) {
                        targetTbody.insertBefore(draggedRow, nextTo);
                    } else {
                        targetTbody.appendChild(draggedRow);
                    }
                    renumerarCanales(); // <-- ¬°NUEVO! Renumera despu√©s del reordenamiento
                }
            }
            targetRow.classList.remove('drag-over');
        });

        row.addEventListener('dragend', () => {
            draggedRow.classList.remove('dragging');
            draggedRow = null;
            document.querySelectorAll('.drag-over').forEach(r => r.classList.remove('drag-over'));
            saveStateSilencioso(); 
        });
    }

    function attachDragEvents() {
        document.querySelectorAll('#lista-canales-body tr, #lista-salidas-body tr').forEach(row => {
            attachDragEventsToRow(row);
        });
        
        // Re-adjuntar listener para inputs CH/Mix
        document.querySelectorAll('.ch-input').forEach(input => {
            input.addEventListener('change', saveStateSilencioso);
            input.addEventListener('keyup', saveStateSilencioso);
        });
    }


    // ----------------------------------------------------
    // UTILIDADES (Acorde√≥n, Vistas, Exportaci√≥n)
    // ----------------------------------------------------

    window.toggleAcordeon = function(header) {
        const content = header.nextElementSibling;
        
        document.querySelectorAll('.categoria-contenido').forEach(c => {
            if (c !== content && c.classList.contains('abierto')) {
                c.classList.remove('abierto');
                c.style.maxHeight = null;
            }
        });

        if (content.classList.contains('abierto')) {
            content.classList.remove('abierto');
            content.style.maxHeight = null;
        } else {
            content.classList.add('abierto');
            content.style.maxHeight = content.scrollHeight + "px";
        }
    };
    
    window.setView = function(view) { 
        currentView = view;
        const mainWorkspace = document.getElementById('main-workspace');
        const riderContainer = document.getElementById('rider-container');
        const btnStagePlot = document.getElementById('btn-stageplot');
        const btnRider = document.getElementById('btn-rider');

        btnStagePlot.classList.remove('active');
        btnRider.classList.remove('active');
        
        if (view === 'stagePlot') {
            mainWorkspace.style.display = 'flex';
            riderContainer.classList.remove('visible');
            btnStagePlot.classList.add('active'); 
        } else {
            mainWorkspace.style.display = 'none';
            riderContainer.classList.add('visible');
            btnRider.classList.add('active'); 
        }
    }
    
    window.generarStagePlotPDF = function() {
        removeTransformer();
        const stageDataURL = stage.toDataURL({ mimeType: 'image/png', quality: 1.0, pixelRatio: 2 });
        const pdf = new jsPDF('l', 'mm', 'a4'); 
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const padding = 10; 
        const ratio = STAGE_WIDTH / STAGE_HEIGHT;
        let imgWidth = pdfWidth - 2 * padding;
        let imgHeight = imgWidth / ratio;
        if (imgHeight > pdfHeight - 2 * padding) {
            imgHeight = pdfHeight - 2 * padding;
            imgWidth = imgHeight * ratio;
        }
        const x = (pdfWidth - imgWidth) / 2;
        const y = (pdfHeight - imgHeight) / 2;
        pdf.addImage(stageDataURL, 'PNG', x, y, imgWidth, imgHeight);
        const title = headerTitleInput.value || "Stage_Plot";
        pdf.save(title.replace(/\s/g, '_') + "_Plot.pdf");
    }
    
    /** * Funci√≥n: Exporta solo las tablas de Input y Output.
     */
    window.generarListasPDF = function() {
        const originalView = currentView;
        setView('rider'); 

        // Clonamos solo los elementos necesarios
        const tempContainer = document.createElement('div');
        tempContainer.style.width = '800px'; 
        tempContainer.style.padding = '25px';
        tempContainer.style.backgroundColor = 'white';

        const headerClone = document.getElementById('header-documento').cloneNode(true);
        tempContainer.appendChild(headerClone);
        
        const inputTitleClone = document.querySelector('.rider-section-title:nth-of-type(2)').cloneNode(true); 
        tempContainer.appendChild(inputTitleClone);
        const inputTableClone = document.getElementById('input-list-table').cloneNode(true); 
        tempContainer.appendChild(inputTableClone);
        
        const outputTitleClone = document.querySelector('.rider-section-title:nth-of-type(3)').cloneNode(true);
        tempContainer.appendChild(outputTitleClone);
        const outputTableClone = document.getElementById('output-list-table').cloneNode(true); 
        tempContainer.appendChild(outputTableClone);

        document.body.appendChild(tempContainer);
        
        html2canvas(tempContainer, {
            scale: 2, useCORS: true, allowTaint: true,
        }).then(canvas => {
            document.body.removeChild(tempContainer); 
            
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const imgWidth = 210; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
            
            setView(originalView); 
            
            let title = headerTitleInput.value || "Rider_Listas";
            if (title.length > 50) { 
                title = title.substring(0, 50) + '...';
            }
            pdf.save(title.replace(/\s/g, '_').replace(/[^\w-]/g, '') + "_Listas.pdf");
        });
    }


    window.generarRiderCompletoPDF = function() {
        const originalView = currentView;
        setView('rider'); 
        const target = document.getElementById('documento-final'); 
        
        document.body.style.overflow = 'hidden'; 
        
        html2canvas(target, {
            scale: 2, 
            useCORS: true, allowTaint: true,
            ignoreElements: (element) => {
                return element.id === 'acciones-flotantes' || element.id === 'toolbar-gestion' || element.tagName === 'BUTTON'; 
            }
        }).then(canvas => {
            document.body.style.overflow = ''; 
            
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const imgWidth = 210; 
            const pageHeight = 297; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            let position = 0;
            
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            while (heightLeft >= 0) {
                position = heightLeft - pageHeight; 
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            
            setView(originalView); 
            
            let title = headerTitleInput.value || "Rider_Tecnico";
            if (title.length > 50) { 
                title = title.substring(0, 50) + '...';
            }
            pdf.save(title.replace(/\s/g, '_').replace(/[^\w-]/g, '') + "_Rider.pdf");
        });
    }

    // ----------------------------------------------------
    // INICIALIZACI√ìN FINAL
    // ----------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) {
            drawGridAndFrame();
        } else {
            loadProject();
            // Asegurarse de que los n√∫meros de CH/Mix sean correctos despu√©s de cargar
            renumerarCanales(); 
        }
        
        const allContents = document.querySelectorAll('.categoria-contenido');
        allContents.forEach(c => {
            c.style.maxHeight = null;
        });
        const firstContent = document.querySelector('.categoria-contenido.abierto');
        if (firstContent) {
            firstContent.style.maxHeight = firstContent.scrollHeight + "px";
        }
        
        riderInputs.forEach(input => {
            input.addEventListener('change', saveStateSilencioso);
            input.addEventListener('keyup', saveStateSilencioso);
        });
        
        // Adjuntar eventos de arrastre y edici√≥n manual al cargar o crear
        attachDragEvents();
        
        // Adjuntar eventos de arrastre a los iconos de herramientas est√°ndar
        document.querySelectorAll('.icono-arrastrable:not(.custom-icon-preview)').forEach(attachToolIconDragEvent);
    });
    
    window.newProject = function() { 
        if (confirm('¬øEst√°s seguro de que quieres empezar un proyecto nuevo? Se perder√°n los cambios no guardados en el navegador.')) {
            localStorage.removeItem(STORAGE_KEY);
            // Tambi√©n eliminar el icono personalizado del almacenamiento para un proyecto "limpio"
            localStorage.removeItem(CUSTOM_ICON_STORAGE_KEY); 
            window.location.reload(); 
        }
    }
    
</script>
</body>
</html>